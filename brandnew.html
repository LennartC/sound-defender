<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <script src="dist/paper.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="jquery-min.js"></script>
    <script src="http://mixmini.mixlab.be:3000/javascripts/api.js" type='text/javascript'></script>
    <title>Paper.js - Paper.js</title>
</head>
<body style="overflow:hidden">
<script>
  var socket = io.connect('http://lacerta.be');
  socket.on('news', function (data) {
    socket.emit('host');
    socket.on('down',function(data){
        changeHeight(data.player,1);
    });
    socket.on('up',function(data){
        changeHeight(data.player,-1);
    });
    socket.on('shoot',function(data){
        shoot(data.player);
    });
    socket.on('live',function(data){
        live(data.player);
    })
  });
  function kill(player){
    if(players[player].live){
        
        socket.emit("kill",{player:player,score:(players[player].score||0)});
        players[player].score=0;
        players[player].live=false;
        for(var i=0;i<5;i++){
            if(players[player].live){
                players[player].score=(players[player].score||0)+50;
            }
        }
    }
  }
  function live(player){
    players[player].live=true;
    players[player].score=0;
  }
</script>
<script type="text/javascript">
    var evildoers=[];
    var app = new MixApi();
    app.init(function(){
        app.onNoteOn(function(note, velocity, channel){
            if(velocity>10){

                var height=11-(note%12);
                var bottom= path.segments[127].point.y;
                evildoers.push({y:bottom/11*height});
            }
        });
    });

</script>
<script type="text/javascript">
	var path;
	var eq;
	var player;
    var oomph=1000; // the beat threshold
    var energythreshold=1; // how much the previous point can differ from the next point
    var booms=false;
    var viewding=0;
    var url = 'test.mp3';
    var graphType = 'loudness' // numba, loudness, level
var colors=["#FF00FF","#FFFF00","#00FF00","#00FFFF","#0000FF"];
function newcol(){
	var h=rnd(360),l=rnd(30);
	document.body.style.backgroundColor="hsl("+h+",50%,"+(100-l)+"%)";
	path.fillColor="hsl("+(h+180)+",50%,"+l+"%)";
}
var interval=setInterval(difficult,1000);
function difficult(){
	energythreshold++;
	if(energythreshold>100){
		clearInterval(interval);
	}
}
var keyup=false;
function rnd(num){
    return Math.floor(Math.random()*num);
}
    function getPrimes(max) {
        var sieve = [], i, j, primes = [];
        for (i = 2; i <= max; ++i) {
            if (!sieve[i]) {
                // i has not been marked -- it is prime
                primes.push(i);
                for (j = i << 1; j <= max; j += i) {
                    sieve[j] = true;
                }
            }
        }
        return primes;
    }
    var primes=getPrimes(1024);
    var lookup=[1,1];
    for(var i=2;i<=1024;i++){
        var num=i;
        var tel=0;
        var search=true;
        while(search){
            if(num%primes[tel]==0){
                num=num/primes[tel];
            }else if(primes[tel]<num){
                tel++;
            }else{
                lookup[i]=tel==0?1:primes[tel];
                search=false;
            }
        }
    }
    var players=[];
    var step=0;

setInterval(movePlayers,10);
var bulletspeed=20;
var bulletcount=5;
var bulletpoints=[];
function movePlayers(){
    for(var i=0;i<players.length;i++){
        pl=players[i];
        if(pl.currentpixel<pl.target*step){
            pl.currentpixel+=step/10;
            if(pl.currentpixel>pl.target*step){
                pl.currentpixel=pl.target*step;
                pl.direction=0;
            }
        }else if(pl.currentpixel>pl.target*step){
            pl.currentpixel-=step/10;
            if(pl.currentpixel<pl.target*step){
                pl.currentpixel=pl.target*step;
                pl.direction=0;
            }
        }
        pl.currentHeight=Math.floor(pl.currentpixel/step);
        for(var j=0;j<pl.bullets.length;j++){
            var bullet = pl.bullets[j];
            if(bullet.active){
                bullet.currentpixel+=bulletspeed;
            }
        }   
    }
}
function changeHeight(playernr,height){
    if(playernr>players.length-1){
        return;
    }
    if(players[playernr].direction==height){
        players[playernr].target=players[playernr].target+height;

    }else{
        players[playernr].target=players[playernr].currentHeight+height;    
    }
    players[playernr].direction=height;
    if(players[playernr].target>40){
        players[playernr].target=40;
    }else if(players[playernr].target<0){
        players[playernr].target=0;
    }
};
function shoot(playernr){
    if(playernr>players.length-1){
        return;
    }
    for(var i=0;i<bulletcount;i++){
        var bullet = players[playernr].bullets[i];
        if(!players[playernr].bullets[i].active){
            players[playernr].bullets[i].active=true;
            players[playernr].bullets[i].y=players[playernr].currentpixel;
            players[playernr].bullets[i].currentpixel=(players[playernr].xpos+1)*viewding/128;
            break;
        }
    }    
}
</script>
<script type="text/paperscript" canvas="canvas-1">
var width, height, center;
var points = 128;
var smooth = false;
var pathHeight = 0;
var soundArray;
var context;
var source;
var analyser;
var buffer;
var audioBuffer;
var javascriptNode;
for(var i=0;i<5*bulletcount;i++){
    bulletpoints[i]=new Path.Circle({
        radius:8,
        strokeColor:'black',
        fillColor:'white',
        center:{x:-100,y:-100}
    });
}
eq = new Path();
eq.fillColor = 'rgba(0,0,0,0.5)';
path = new Path();
path.fillColor = 'black';
playcollection=[];
for(var i=0;i<5;i++){
    var p=new Path.Circle({
        radius:10,
        strokeColor:'black',
        fillColor:colors[i],
        center:{x:(10+(i*3))*view.size.width/128,y:view.center.y-10}
    });
    playcollection[i]=p;
}
viewding=view.size.width;
/*player=new Path.Circle({
	radius:10,
	strokeColor: 'black',
	fillColor: 'orange',
	center:{x:10*view.size.width/128, y:view.center.y-10}
});*/
initializePath();
initializeEQ();
function initializePath() {
    center = view.center;
    width = view.size.width;
    height = view.size.height / 2;
    path.segments = [];
    path.add(view.bounds.bottomLeft);
    for (var i = 0; i < points; i++) {
        var point = new Point(width / points * i, center.y);
        path.add(point);
    }
    path.add(new Point(width / points * i,view.size.height));
    path.add(view.bounds.bottomRight);
    path.fullySelected = false;
}
function initializeEQ() {
    center = view.center;
    width = view.size.width;
    height = view.size.height / 2;
    eq.segments = [];
    eq.add(new Point(0,height*2));
    //path.add(view.bounds.bottomLeft);
    for (var i = 0; i < points; i++) {
        var point = new Point(width / points * i, height);
        eq.add(point);
    }
    eq.add(new Point(width / points * i,height));
    eq.add(new Point(width / points * i,height*2));
    eq.fullySelected = false;
}
function loadSound() {
    if (url) {
        initFromMP3(url);
    } else {
        navigator.webkitGetUserMedia({audio:true}, initAudio, onError);
    }
}

function initFromMP3(url) {
    context = new AudioContext();
    javascriptNode = context.createScriptProcessor(256, 2, 1);
    javascriptNode.connect(context.destination);
    
    analyser = context.createAnalyser();

    var audio = new Audio();
    audio.src = url;

    audio.addEventListener('canplaythrough', function() {
          audio.play();
    }, false);
    var sourceNode = context.createMediaElementSource(audio);
    sourceNode.connect(analyser);
    sourceNode.connect(context.destination);

    javascriptNode.onaudioprocess = function() {
        soundArray =  new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(soundArray);
    }
}

function initAudio(stream) {
    context = new webkitAudioContext();
    javascriptNode = context.createScriptProcessor(256, 2, 1);
    javascriptNode.connect(context.destination);
    
    analyser = context.createAnalyser();

    // Connect audio processing graph:
    // live-input -> analyser -> destination

    // Create an AudioNode from the stream.
    var mediaStreamSource = context.createMediaStreamSource(stream);    
    mediaStreamSource.connect(analyser);
    analyser.connect(context.destination);
    javascriptNode.onaudioprocess = function() {
        soundArray =  new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(soundArray);
    }
}

// log if an error occurs
function onError(e) {
    console.log(e);
}
if (! window.AudioContext) {
    if (! window.webkitAudioContext) {
        alert('no audiocontext found');
    }
    window.AudioContext = window.webkitAudioContext;
}
loadSound();
var prev=false;
var restEnergy=0;
var booming=0;
var averagevolume=0;
var velocity=0;
var gravity=.9;
function onKeyDown(event) {
	
}
playerheight=5;
var height = view.size.height;
step = height/20;
    players=[];
for(var i=0;i<5;i++){
    var player={xpos:10+(i*3),currentHeight:5,currentpixel:5*step,target:5,direction:0,live:false,score:0};
    var bullets=[];
    for(var j=0;j<bulletcount;j++){
        bullets[j]={active:false,currentpixel:-100,y:-100};
    }
    player.bullets=bullets;
    players[i]=player;
}
function onKeyUp(event){
    if(event.key=="a"){
        changeHeight(0,-1);
        /*playerheight--;
        if(playerheight<0){
            playerheight=0;
        }*/
    }else if(event.key=="q"){
        changeHeight(0,1);
/*        playerheight++;
        if(playerheight>40){
            playerheight=40;
        }*/
    }else if(event.key=="m"){
        shoot(0);
    }
}

var loudnessHistory = new Array(points);
var beatHistory = new Array(points);
var numbaHistory = new Array(points);
function onFrame(event) {
          if (soundArray) {
            var varue=-1;
            var numba=0;
            //console.log(bandsize);
            bins=[];
            var highestbin=0;
            var highestvalue=-1;
            // pas vanaf waarde 3 gebruiken om de ruis te filteren
            for ( var i = 3; i < 127/*(soundArray.length)*/; i++ ){
                /*bins[lookup[i+1]]=(bins[lookup[i+1]]||0)+(soundArray[i]*lookup[i+1]/2);
                if(bins[lookup[i+1]]>highestvalue){
                    highestbin=lookup[i+1];
                    highestvalue=bins[lookup[i+1]];
                }*/
                eq.segments[i+1].point.y=view.size.height-soundArray[i];
                var vallie=soundArray[i];//*((i+1)/soundArray.length);
                if(vallie>varue){
                    varue=vallie;
                    numba=i;
                }

            }
            var level=0;
            for(var i=0;i<5;i++){
                level+=soundArray[5+i];
            }
            level=soundArray[3]*5;
            averagevolume=(averagevolume+level)/2;

            if(level>oomph){
                if(!prev){
                    newcol();
                    prev=true;
                }else if(booms && booming<=0){
                    var quake=rnd(path.segments.length-60)+40;
                    var low=(view.size.height-path.segments[quake].point.y)/4;
                    path.segments[quake].point.y=view.size.height-low*3;
                    path.segments[quake-1].point.y-=low;
                    path.segments[quake-2].point.y-=low/2;
                    path.segments[quake+1].point.y-=low;
                    path.segments[quake+2].point.y-=low/2;
                    booming=1;
                    console.log("*****");
                }else{
                    booming++;
                }
                oomph=level-(level-oomph)/4;
            }else{
                booming--;
                var tmp=oomph-averagevolume;
                oomph=oomph-(tmp/100);
                prev=false;
            }



            /*for ( var i = 0; i < (soundArray.length); i++ ){
                var newnum=soundArray[i]*bins[lookup[i+1]];
                if(newnum>varue){
                    varue=newnum;
                    numba=i;
                }
            }*/

            loudnessHistory.shift();
            beatHistory.shift();
            numbaHistory.shift();

            var loudness = 0
            for (var i=0; i<soundArray.length; i++) { loudness += soundArray[i]; }

            loudnessHistory.push(loudness);
            beatHistory.push(level);
            numbaHistory.push(numba);

            var value = center.y*2 - numba*4;

            if (graphType === 'level') value = center.y*2 - level/4;
            else if (graphType === 'loudness') value = center.y*2 - loudness/400;

            //value=center.y*2-(level/4);
            // display beat plus beat threshold
            path.segments[3].point.y=center.y*2-(level/4);
            path.segments[4].point.y=center.y*2-(level/4);
            path.segments[1].point.y=center.y*2-(oomph/4);
            path.segments[2].point.y=center.y*2-(oomph/4);

            //console.log(numba+":"+varue);
            /*var teller=0;
            for(var bi in bins){
                teller++;
                console.log(bi);
                //console.log(teller);
                path.segments[teller].point.y=view.size.height-(bins[bi]/100);
            }*/

            // scroll points
            for ( var i = 5; i < (path.segments.length-2); i++ ){
                path.segments[i].point.y = path.segments[i+1].point.y;
            }
            //path.segments[i].point.y=(path.segments[i-2].point.y+path.segments[i-1].point.y+value)/3;
            var last=path.segments.length-2;
            var energy=path.segments[last-1].point.y-(value+(restEnergy/2));
            if(energy>energythreshold){
            	//console.log(energy);
            	restEnergy=(energy-energythreshold)/3;
            	energy=energythreshold;
            }else if(energy<(0-energythreshold)){
            	//console.log(energy);
            	restEnergy=(energy+energythreshold)/3;
            	energy=-energythreshold;
            }else{
            	restEnergy=restEnergy/3;
            }
            path.segments[last].point.y=path.segments[last-1].point.y-energy;
//path.segments[last].point.y=value;

			/*player.position.y-=velocity;
			if(player.position.y+10>path.segments[11].point.y){
				velocity+=player.position.y+10-path.segments[11].point.y
				player.position.y=path.segments[11].point.y-10;
			}else{

				if(player.position.y+10>path.segments[10].point.y){
					player.position.y=path.segments[10].point.y-10;
					if(velocity<0){
						velocity=0;
					}
				}
			}*/
            for(var i=0;i<5;i++){
                var p=playcollection[i];
                p.position.y=players[i].currentpixel;
                if(p.position.y+10>path.segments[10+(i*3)].point.y){
                    players[i].currentpixel=0;
                    players[i].currentHeight=0;
                    players[i].target=0;
                    p.position.y=0;
                    kill(i);
                }
                for(var j=0;j<bulletcount;j++){
                    if(players[i].bullets[j].active){
                        bulletpoints[i+(j*5)].position.x=players[i].bullets[j].currentpixel;
                        bulletpoints[i+(j*5)].position.y=players[i].bullets[j].y;
                        var reference=path.segments[Math.floor(bulletpoints[i+(j*5)].position.x*128/viewding)].point.y;
                        if(bulletpoints[i+(j*5)].position.y>=reference || bulletpoints[i+(j*5)].position.x>viewding){
                            players[i].bullets[j].active=false;
                            players[i].bullets[j].currentpixel=-100;
                            bulletpoints[i+(j*5)].position.y=-100;
                            bulletpoints[i+(j*5)].position.x=-100;
                        }else{
                            for(var k=0;k<evildoers.length;k++){
                                var e=evildoers[k];
                                if(typeof e.y=="undefined"){
                                    var b=bulletpoints[i+(j*5)];
                                    if(b.position.x>e.position.x-20 && b.position.x<e.position.x+20 && b.position.y>e.position.y-10 && b.position.y<e.position.y+10){
                                        e.remove();
                                        evildoers.splice(k,1);
                                        players[i].bullets[j].active=false;
                                        players[i].bullets[j].currentpixel=-100;
                                        players[i].score=(players[i].score||0)+10;
                                        bulletpoints[i+(j*5)].position.y=-100;
                                        bulletpoints[i+(j*5)].position.x=-100;
                                    }
                                }
                            }
                        }
                    }
                }
    
            }
            /*player.position.y=players[0].currentpixel;
            if(player.position.y+10>path.segments[10].point.y){
                players[0].currentpixel=0;
                players[0].currentHeight=0;
                players[0].target=0;
                player.position.y=0;
            }*/
			velocity-=gravity;
			eq.smooth();
            if (smooth)
                    path.smooth();
          }
          for(var i=0;i<evildoers.length;i++){
            var e=evildoers[i];
            if(typeof e.y !=='undefined'){
                var n=new Path.Circle({
                    radius:10,
                    strokeColor:'black',
                    fillColor:'red',
                    center:{x:path.segments[127].point.x,y:e.y}
                });
                evildoers.splice(i,1,n);
       
            }else{
                e.position.x-=view.size.width / points;
                if(e.position.x<0){
                    e.remove();
                    evildoers.splice(i,1);
                    i--;
                }else{
                    for(var j=0;j<5;j++){
                        var p=playcollection[j];
                        if(p.position.x>e.position.x-20 && p.position.x<e.position.x+20 && p.position.y>e.position.y-20 && p.position.y<e.position.y+20){
                            players[j].currentpixel=0;
                            players[j].currentHeight=0;
                            players[j].target=0;
                            p.position.y=0;
                            kill(j);
                            e.remove();
                            evildoers.splice(i,1);
                            i--;

                        }
                    }
                }
            }
          }

    }




</script>
<div class="canvas">
    <canvas resize="true" id="canvas-1"></canvas>
</div>
</div></article>
</body>
</html>